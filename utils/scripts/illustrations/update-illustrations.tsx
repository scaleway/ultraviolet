import { appendFileSync, readdirSync, statSync, writeFileSync } from 'node:fs'
import path from 'node:path'
import {
  updateDynamicIllustrations,
  updateWireIllustrations,
} from './update-components'

const ILLUSTRATIONS_DIR = 'packages/illustrations/src/assets'
const BASE_URL = 'https://assets.scaleway.com/illustrations'
const ILLUSTRATIONS_CATEGORIES: { dir: string; category: string }[] = []
const DYNAMIC_ILLUSTRATIONS: { dir: string; category: string }[] = []
const OXLINT_RULES = `
    // oxlint-disable import/no-namespace
  `
const WARNING = `/**
      * This file is automatically generated from /utils/scripts/illustrations/update-illustrations.tsx
      * PLEASE DO NOT EDIT HERE
      */`

// Updates ILLUSTRATIONS_CATEGORIES & DYNAMIC_ILLUSTRATIONS
const updateListIllustrationsCategories = (directory: string) => {
  const dirName = path.basename(directory)

  if (dirName.endsWith('-wire.svg')) {
    const parentDir = path.dirname(directory)
    const parentDirName = path.basename(parentDir)
    ILLUSTRATIONS_CATEGORIES.push({
      category: dirName.replace('-wire.svg', ''),
      dir: parentDirName,
    })
  }

  if (dirName.endsWith('-dark.webp') || dirName.endsWith('-light.webp')) {
    const parentDir = path.dirname(directory)
    const parentDirName = path.basename(parentDir)
    DYNAMIC_ILLUSTRATIONS.push({
      category: dirName.replace('.webp', ''),
      dir: parentDirName,
    })
  }
}

// Add .webp and .svg files to index.ts
const importIllustration = (
  directory: string,
  file: string,
  output: string,
  illustrations: string[],
) => {
  const parsedFile = path.parse(file)

  if (parsedFile.ext === '.webp' || parsedFile.ext === '.svg') {
    const filename = parsedFile.name.replace(/-./g, x => x[1].toUpperCase())
    const relativePath = directory.split('illustrations/src/assets/')[1]

    updateListIllustrationsCategories(directory)

    illustrations.push(filename)
    appendFileSync(
      output,
      `const ${filename} = \`\${BASE_URL}/${relativePath.replace(/\\/g, '/')}\`\n`,
    )
  }
}

// Find folders and files of illustrations
const findFiles = (dir: string, output: string, illustrations: string[]) => {
  const files = readdirSync(dir)
  writeFileSync(
    output,
    `${WARNING}\n
      const BASE_URL = '${BASE_URL}'\n\n`,
  )
  files.forEach(file => {
    const fullPath = path.join(dir, file)
    const isDirectory = statSync(fullPath).isDirectory()
    if (isDirectory) {
      findFiles(fullPath, output, illustrations)
    } else {
      importIllustration(fullPath, file, output, illustrations)
    }
  })
}

const exportIllustrations = (output: string, illustrations: string[]) => {
  appendFileSync(output, `\nexport { ${illustrations.toString()} }`)
}

// Create index.ts for every illustration folder
// !! only works if depth < 2 (assets/sub1/sub2/index.ts will be created but not assets/sub1/sub2/sub3/index.ts) !!
const updateIndexes = () => {
  const subDirs = readdirSync(ILLUSTRATIONS_DIR)

  // Go through first subdirectories (product, various)
  subDirs.forEach(subDir => {
    const subDirPath = path.join(ILLUSTRATIONS_DIR, subDir)

    if (
      statSync(subDirPath).isDirectory() &&
      !['__stories__', 'components'].includes(subDir)
    ) {
      const files = readdirSync(subDirPath)

      // Create index for each directory inside the subdirectories
      files.forEach(element => {
        const fullPath = path.join(subDirPath, element)
        if (statSync(fullPath).isDirectory()) {
          const illustrations: string[] = []
          findFiles(fullPath, `${fullPath}/index.ts`, illustrations)
          exportIllustrations(`${fullPath}/index.ts`, illustrations)
        }
      })
    }
  })
}

// Export all products in products/index.ts
const exportProducts = () => {
  const PRODUCTS_DIR = `${ILLUSTRATIONS_DIR}/products`
  const productsDirs = readdirSync(PRODUCTS_DIR)
  const productExports: string[] = []
  writeFileSync(`${PRODUCTS_DIR}/index.ts`, `${WARNING}\n`)
  appendFileSync(`${PRODUCTS_DIR}/index.ts`, `${OXLINT_RULES}\n`)
  productsDirs.forEach(productDir => {
    const fullPath = path.join(PRODUCTS_DIR, productDir)
    if (statSync(fullPath).isDirectory()) {
      appendFileSync(
        `${PRODUCTS_DIR}/index.ts`,
        `\nimport * as ${productDir} from './${productDir}'`,
      )
      productExports.push(productDir)
    }
  })

  appendFileSync(
    `${PRODUCTS_DIR}/index.ts`,
    `\n\nexport { ${productExports.toString()}}`,
  )
}

updateIndexes()
exportProducts()
updateWireIllustrations(ILLUSTRATIONS_CATEGORIES, BASE_URL)
updateDynamicIllustrations(DYNAMIC_ILLUSTRATIONS, BASE_URL)
